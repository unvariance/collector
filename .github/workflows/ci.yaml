name: ci

on:
  pull_request:
    paths:
      - 'crates/**'
      - 'charts/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'Containerfile'
      - '.github/workflows/**'
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      level:
        description: Test level to run (cheap-short|perf-short|full-short|full-long)
        required: false
        default: cheap-short
        type: choice
        options:
          - cheap-short
          - perf-short
          - full-short
          - full-long

permissions:
  contents: read
  packages: write
  id-token: write
  actions: write

jobs:
  context:
    runs-on: ubuntu-latest
    outputs:
      short-sha: ${{ steps.sha.outputs.SHORT_SHA }}
      is-pr: ${{ github.event_name == 'pull_request' }}
      level: ${{ steps.level.outputs.level }}
      run-multi-kernel-tests: ${{ steps.changed.outputs.any_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Compute short SHA
        id: sha
        run: |
          SHORT_SHA=$(git rev-parse --short=7 ${{ github.sha }})
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_OUTPUT
      - name: Detect changes in eBPF-related crates
        id: changed
        uses: tj-actions/changed-files@v45
        with:
          files: |
            crates/bpf/**
            crates/bpf-sync-timer/**
            crates/per_events/**
      - name: Select level
        id: level
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "level=${{ github.event.inputs.level }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "level=cheap-short" >> $GITHUB_OUTPUT
          else
            # merges to main: run full-long
            echo "level=full-long" >> $GITHUB_OUTPUT
          fi

  build-collector:
    name: Build collector (amd64)
    needs: [context]
    uses: ./.github/workflows/build-component-artifacts.yaml
    with:
      runner: ubuntu-24.04
      component: collector
      push: ${{ github.event_name != 'pull_request' }}
      image-repository: ghcr.io/${{ github.repository }}/collector
      image-tag: main-${{ needs.context.outputs.short-sha }}
      upload-image-artifact: true
      upload-binary-artifact: true

  build-nri-init:
    name: Build nri-init (amd64)
    needs: [context]
    uses: ./.github/workflows/build-component-artifacts.yaml
    with:
      runner: ubuntu-24.04
      component: nri-init
      push: ${{ github.event_name != 'pull_request' }}
      image-repository: ghcr.io/${{ github.repository }}/nri-init
      image-tag: main-${{ needs.context.outputs.short-sha }}
      upload-image-artifact: true
      upload-binary-artifact: true

  rust-lint:
    needs: [context]
    uses: ./.github/workflows/reusable-rust-lint.yaml
  unit-tests:
    needs: [context]
    uses: ./.github/workflows/reusable-unit-tests.yaml
  helm-lint:
    needs: [context]
    uses: ./.github/workflows/reusable-helm-lint.yaml

  test-nri:
    uses: ./.github/workflows/reusable-test-nri.yaml

  test-collector:
    if: needs.context.outputs.level != 'cheap-short'
    needs: [build-collector, context]
    uses: ./.github/workflows/reusable-test-collector.yaml
    secrets: inherit
    with:
      level: ${{ needs.context.outputs.level }}
      collector-binary-artifact: collector-binary
      instance-type: ${{ needs.context.outputs.level == 'perf-short' && 'c5.9xlarge' || 'm7i.metal-24xl' }}
      run-multi-kernel-tests: ${{ needs.context.outputs.run-multi-kernel-tests == 'true' }}

  test-resctrl-collector:
    if: needs.context.outputs.level == 'full-long'
    needs: [build-collector, context]
    uses: ./.github/workflows/reusable-test-resctrl-collector.yaml
    secrets: inherit
    with:
      level: ${{ needs.context.outputs.level }}
      collector-binary-artifact: collector-binary
      instance-type: 'm7i.metal-24xl'

  test-resctrl:
    if: needs.context.outputs.level == 'full-short' || needs.context.outputs.level == 'full-long'
    needs: [context]
    uses: ./.github/workflows/reusable-test-resctrl.yaml
    secrets: inherit
    with:
      level: ${{ needs.context.outputs.level }}

  test-helm:
    if: needs.context.outputs.level != 'cheap-short'
    needs: [build-collector, build-nri-init, context]
    uses: ./.github/workflows/reusable-test-helm.yaml
    secrets: inherit
    with:
      collector-image-repo: ${{ needs.build-collector.outputs.image_repo }}
      collector-image-tag: ${{ needs.build-collector.outputs.image_tag }}
      collector-image-artifact: ${{ needs.build-collector.outputs.image_artifact }}
      nri-init-image-repo: ${{ needs.build-nri-init.outputs.image_repo }}
      nri-init-tag: ${{ needs.build-nri-init.outputs.image_tag }}
      nri-init-image-artifact: ${{ needs.build-nri-init.outputs.image_artifact }}
      instance-type: m7i.metal-24xl
